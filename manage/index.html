<!DOCTYPE html>
<html>
	<head>
		<title>Illinois Tech ACM</title>
		<script src="https://www.gstatic.com/firebasejs/3.7.3/firebase.js"></script>
		<script>

			var config = {
			apiKey: "AIzaSyCGWEpvuy4sPR3n5xzwfATLzyMDvwE6tOY",
			authDomain: "illinois-tech-acm.firebaseapp.com",
			databaseURL: "https://illinois-tech-acm.firebaseio.com",
			storageBucket: "illinois-tech-acm.appspot.com",
			messagingSenderId: "344533734310"
			};

			firebase.initializeApp(config);

		</script>
		<style type="text/css">

			table th {
				text-align: left;
			}

			table td {
				vertical-align: top;
			}

			table td:nth-child(1) input {
				width: 50px;
			}

			table td:nth-child(2) input {
				width: 175px;
			}

			table td:nth-child(3) textarea {
				width: 250px;
			}

			table td:nth-child(4) input {
				width: 50px;
			}

			table td:nth-child(5) input {
				width: 50px;
			}

			table td:nth-child(6) input {
				width: 100px;
			}

		</style>
	</head>
	<body>
		
		<h1>Edit Challenges</h1>
		<h2 id="contest-name">Loading...</h2>
		<div id="flag-board">
			<div>Loading...</div>
			<br>
			<button id="add-flag">Add New Flag</button>
		</div>
		
		<script type="text/javascript">

			var CONTEST_ID = 'clarity2017'; // prompt('Enter Contest ID.');

			var db = firebase.database();

			db.ref('ctf/' + CONTEST_ID + '/flags').on('value', (snapshot) => {
				var flags = snapshot.val();
				console.log(flags);
				var board = renderFlagBoard(flags);
				var flagBoard = document.getElementById('flag-board')
				flagBoard.replaceChild(board, flagBoard.children[0]);
			});

			db.ref('ctf/' + CONTEST_ID + '/details').once('value', (snapshot) => {
				var contestName = document.getElementById('contest-name');
				contestName.innerText = snapshot.val().name;
			});

			function on(node, event, fn){
				node.addEventListener(event, fn);
			}

			function updateFlagCode(e){
				var code = e.target.value;
				var flagid = e.target.dataset.flagid;
				console.log('Update Name to: ' + code);
				db.ref('ctf/' + CONTEST_ID + '/flags/' + flagid).once('value', (snapshot) => {
					var flag = snapshot.val();
						flag.code = code;
					var prom = db.ref('ctf/' + CONTEST_ID + '/flags/' + code).set(flag);
					prom.then(d => {
						db.ref('ctf/' + CONTEST_ID + '/flags/' + flagid).remove();
					});
				});
			}

			function updateFlagName(e){
				var name = e.target.value;
				var flagid = e.target.dataset.flagid;
				console.log('Update Name to: ' + name);
				db.ref('ctf/' + CONTEST_ID + '/flags/' + flagid + '/name').set(name);
			}

			function updateFlagDescription(e){
				var desc = e.target.value;
				var flagid = e.target.dataset.flagid;
				console.log('Update Description to: ' + desc);
				db.ref('ctf/' + CONTEST_ID + '/flags/' + flagid + '/description').set(desc);
			}

			function updateFlagLink(e){
				var link = e.target.value;
				var flagid = e.target.dataset.flagid;
				console.log('Update Link to: ' + link);
				db.ref('ctf/' + CONTEST_ID + '/flags/' + flagid + '/link').set(link);
			}

			function updateFlagPoints(e){
				var points = e.target.value;
				var flagid = e.target.dataset.flagid;
				console.log('Update Points to: ' + points);
				db.ref('ctf/' + CONTEST_ID + '/flags/' + flagid + '/points').set(points);
			}

			function updateFlagAnswer(e){
				var answer = e.target.value;
				var flagid = e.target.dataset.flagid;
				console.log('Update Answer to: ' + answer);
				db.ref('ctf/' + CONTEST_ID + '/flags/' + flagid + '/answer').set(answer);
			}

			function removeFlag(e){
				var flagid = e.target.dataset.flagid;
				db.ref('ctf/' + CONTEST_ID + '/flags/' + flagid).remove();
			}

			function renderFlagBoard(flags){
				var board = document.createElement('table');

				var header = document.createElement('tr');
				var labels = ['Code', 'Name', 'Description', 'Link', 'Points', 'Answer', 'Remove'];
					labels.forEach(l => {
						var th = document.createElement('th');
						th.innerText = l;
						header.appendChild(th);
					});
				board.appendChild(header);

				for(var f in flags){
					var flag = flags[f];
					var row = document.createElement('tr');
					var content = [];

					var code = document.createElement('input')
						code.type = 'text';
						code.value = flag.code;
						code.dataset.flagid = f;
						on(code, 'change', updateFlagCode);
						content.push(code);

					var name = document.createElement('input');
						name.type = 'text';
						name.value = flag.name;
						name.dataset.flagid = f;
						on(name, 'change', updateFlagName);
						content.push(name);

					var desc = document.createElement('textarea');
						desc.value = flag.description;
						desc.dataset.flagid = f;
						on(desc, 'change', updateFlagDescription);
						content.push(desc);

					var link = document.createElement('input');
						link.type = 'text';
						link.value = flag.link;
						link.dataset.flagid = f;
						on(link, 'change', updateFlagLink);
						content.push(link);

					var points = document.createElement('input');
						points.type = 'number';
						points.value = flag.points;
						points.dataset.flagid = f;
						on(points, 'change', updateFlagPoints);
						content.push(points);

					var answer = document.createElement('input');
						answer.type = 'text';
						answer.value = flag.answer;
						answer.dataset.flagid = f;
						on(answer, 'change', updateFlagAnswer);
						content.push(answer);

					var remove = document.createElement('button');
						remove.innerText = 'x';
						remove.dataset.flagid = f;
						on(remove, 'click', removeFlag);
						content.push(remove);

					content.forEach(c => {
						var cell = document.createElement('td');
						cell.appendChild(c);
						row.appendChild(cell);
					});
					board.appendChild(row);
				}

				return board;
			}

			var addFlag = document.getElementById('add-flag');
			on(addFlag, 'click', (e) => {
				db.ref('ctf/' + CONTEST_ID + '/flags').push({
					code: 'X0',
					name: 'New Challenge',
					description: 'None.',
					link: false,
					points: 0,
					answer: 'None'
				});
			});

		</script>

	</body>
</html>